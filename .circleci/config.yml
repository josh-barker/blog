version: 2.1

executors:
  ubuntu:
    docker:
      - image: circleci/golang:stretch

jobs:
  build:
    executor: ubuntu
    working_directory: /tmp/work/blog

    steps:
      - checkout:
          path: /tmp/work

      - run:
          name: Install Hugo
          command: |
              mkdir -p /tmp/hugo_app
              wget -O /tmp/hugo_app/hugo.tar.gz https://github.com/gohugoio/hugo/releases/download/v0.54.0/hugo_extended_0.54.0_Linux-64bit.tar.gz
              sudo tar -xvf /tmp/hugo_app/hugo.tar.gz -C /usr/bin/

      - run:
          name: Build Hugo Site
          command: |
              hugo

      - persist_to_workspace:
          root: /tmp/work
          paths:
            - "*"

  deploy:
    executor: ubuntu
    working_directory: /tmp/work/infrastructure/aws

    steps:
      - attach_workspace:
          at: /tmp/work

      - run:
          name: Setup Terraform
          command: |
              mkdir -p /tmp/terraform_app
              wget -O /tmp/terraform_app/terraform.zip https://releases.hashicorp.com/terraform/0.11.14/terraform_0.11.14_linux_amd64.zip
              sudo unzip /tmp/terraform_app/terraform.zip -d /usr/bin/

      - run:
          name: Install awscli
          command: |
              curl -O https://bootstrap.pypa.io/get-pip.py
              sudo python2.7 get-pip.py
              sudo pip install awscli

      - run:
          name: Run Terraform
          command: |
              export TF_WORKSPACE="${DEFAULT_WORKSPACE}"
              terraform init -backend-config "token=${TFE_TOKEN}" -input=false

              if [[ "${CIRCLE_BRANCH}" != "master" ]]; then
                unset TF_WORKSPACE
                terraform workspace new "${CIRCLE_BRANCH}"
              fi

              terraform apply -auto-approve -input=false -var "blog_source_path=/tmp/work/blog/public"

      - run:
          name: Destroy Terraform Resources
          command: |
            if [[ "${CIRCLE_BRANCH}" == "master" ]]; then
              exit 0
            fi
            terraform destroy -auto-approve -input=false
          when: always

      - run:
          name: Delete Terraform Workspace
          command: |
              if [[ "${CIRCLE_BRANCH}" == "master" ]]; then
                exit 0
              fi
              terraform workspace select "${DEFAULT_WORKSPACE}"
              terraform workspace delete "${CIRCLE_BRANCH}"
          when: always

workflows:
  version: 2

  btd:
    jobs:
      - build
      - deploy:
          requires:
            - build
